name: Update Quote of the Day

on:
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight
  workflow_dispatch:

jobs:
  update-quote:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up environment
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch and update quote
        env:
          GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
          GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Fetch the quote of the day
          QUOTE_JSON=$(curl -s https://zenquotes.io/api/today)
          QUOTE=$(echo "$QUOTE_JSON" | jq -r '.[0].q')
          AUTHOR=$(echo "$QUOTE_JSON" | jq -r '.[0].a')

          # Create the new content for the quote section
          NEW_QUOTE_CONTENT=$(cat <<EOF
### ðŸ’¡ Quote of the Day

_"$QUOTE"_ â€“ $AUTHOR
EOF
)

          # Update the README.md file
          TEMP_FILE=$(mktemp)
          awk -v quote="$NEW_QUOTE_CONTENT" '
            /### ðŸ’¡ Quote of the Day/ {
              in_quote_section = 1
              next
            }
            in_quote_section && /^$/ {
              in_quote_section = 0
              next
            }
            !in_quote_section
          ' README.md > $TEMP_FILE

          echo "$NEW_QUOTE_CONTENT" >> $TEMP_FILE
          mv $TEMP_FILE README.md

          # Commit and push changes
          git config --local user.name "${GIT_USERNAME}"
          git config --local user.email "${GIT_EMAIL}"
          git add README.md
          git commit -m "Update Quote of the Day"
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}
          git push origin main
